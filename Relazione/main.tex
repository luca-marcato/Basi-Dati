\documentclass[10pt]{article}

% font
\usepackage{helvet}
\renewcommand{\familydefault}{\sfdefault}

% formato della pagina
\usepackage{geometry}
\geometry{
   a4paper,
   total={160mm,257mm},
   left=17mm,
   right=17mm,
   top=17mm,
}

% tabelle
\usepackage{tabularx}
\usepackage{ltablex}

% immagini
\usepackage{graphicx}
\usepackage{float}

% SQL 
\usepackage{listings}
\usepackage{xcolor}
\definecolor{backcolour}{rgb}{0.95,0.95,0.96}
\lstdefinestyle{mystyle}{
    backgroundcolor=\color{backcolour}
}
\lstset{style=mystyle}

\begin{document}

\begin{center}
    \huge\textbf{ItaliExpress DB}
\end{center}

\section{Abstract}

\textit{ItaliExpress} è un azienda italiana che vuole aprire la propria attività di mercato online
sul territorio nazionale e come tale necessità di un database per la gestione delle sue risorse.\\
Grazie a \textit{ItaliExpress} sarà possibile fare acquisti tra una vasta serie di prodotti 
senza doversi recare in negozio, potendo scegliere se ricevere la consegna direttamente a casa
propria oppure specificando durante l'acquisto il punto di ritiro che si preferisce,
per poi andarlo a ritirare personalmente.\\
Ogni utente che desidera fare degli acquisti dovrà registrarsi attraverso la propria email,
aggiungendo i propri dati personali e i metodi di pagamento direttamente nel sito.
Inoltre per chi lo desidera ci si potrà abbonare all'offerta "Prime" per evitare i costi di spedizione
su tutti i prodotti certificati Prime e per poter ricevere le propire consegne in brevissimo tempo.
In più verrà fornito l'accesso ad altri servizi esclusivi \textit{ItaliExpress}.\\
Visualizzando i propri acquisti sarà possibile conoscere la data di presa in carico della spedizione
e quella di arrivo al punto di consegna. In caso di necessità sarà anche possibile specificare alcune preferenze
di spedizione, in segutio all'avvenuta operazione di acquisto dei propri prodotti.\\
\textit{ItaliExpress} assicura ai propri clienti che i fornitori siano accertati mettendo a disposizione
la località di produzione ed un recapito telefonico.\\
In caso di guasto o per via di una determinata motivazione specificata dall'utente sarà
possibile effettuare il reso dei prodotti acquistati avendo la garanzia di rimborso della spesa. 

\section{Analisi dei requisiti}

\subsection{Descrizione testuale}

Nella base di dati sono presenti i dati degli \textbf{utenti} registrati, di ogni utente sono noti:
\begin{itemize}
    \itemsep0em 
    \item Nome
    \item Cognome
    \item Indirizzo email
    \item Password 
    \item Numero di telefono
    \item Indirizzo di residenza per la consegna
    \item Metodi di pagamento
\end{itemize}
Un utente può abbonarsi all'offerta "Prime", che avrà durata mensile o annuale in base alla scelta dell'utente.
L'utente abbonato non paga i costi di spedizione su tutti i prodotti indicati.\\
Le \textbf{carte di credito} utilizzate dall’utente devono essere provviste di:
\begin{itemize}
    \itemsep0em 
    \item Numero
    \item Circuito (Mastercard, Visa, …)
    \item Scadenza
    \item CVV
    \item Intestatario
\end{itemize}
I pagamenti vengono autorizzati attraverso un sito esterno, rilevato automaticamente dal circuito.\\
Ogni \textbf{fornitore} deve fornire le informazioni riguardo a:
\begin{itemize}
    \itemsep0em 
    \item Nome
    \item Numero di telefono
    \item Indirizzo email
    \item Partita IVA
    \item Indirizzo (Via, Numero civico, CAP, Città, Provincia, Stato) dei propri stabilimenti
\end{itemize} 
Gli stabilimenti dei fornitori possono trovarsi anche in paesi esteri fuori dall'Italia.\\
Di ogni \textbf{prodotto}, si vuole conoscere:
\begin{itemize}
    \itemsep0em 
    \item Codice
    \item Nome
    \item Prezzo
    \item Quantità disponibile
    \item Peso
    \item Descrizione
    \item Costo di spedizione
    \item Offerta prime
\end{itemize}
Ogni \textbf{ordine} deve memorizzare le informazioni riguardo:
\begin{itemize}
    \itemsep0em 
    \item Carrello (Utente e Prodotti ordinati)
    \item Metodo di pagamento utilizzato
    \item Data e ora di acquisto
    \item Indirizzo di consegna
    \item Preferenze di spedizione (opzionale)
\end{itemize}
Gli ordini possono essere ritirati dal cliente, in quel caso deve essergli fornita la data e l’ora di arrivo della propria consegna al punto di ritiro
scelto oppure possono essere spediti all'indirizzo di residenza dell'utente.\\
Quando viene richiesta una \textbf{spedizione} si vogliono memorizzare le informazioni riguardo:
\begin{itemize}
    \itemsep0em 
    \item Codice
    \item Data di partenza prevista
    \item Data di arrivo prevista
    \item Data effettiva
\end{itemize}
Per ricevere i propri prodotti interessa conoscere i \textbf{punti di consegna}. Per ogni Punto di consegna si vogliono
memorizzare le seguenti informazioni:
\begin{itemize}
    \itemsep0em 
    \item Indirizzo (Via, Numero civico, CAP, Città, Provincia, Stato)
\end{itemize}
Inoltre, se il punto di consegna è un punto di ritiro scelto dall'utente (e quindi non il suo indirizzo di residenza), ci interessa sapere:
\begin{itemize}
    \itemsep0em 
    \item Orario di apertura
    \item Orario di chiusura
\end{itemize}
Infine per effettuare un \textbf{reso} è necessario specificare:
\begin{itemize}
    \itemsep0em 
    \item Utente
    \item Prodotto acquistato
    \item Quantità da rendere
    \item Motivazione 
\end{itemize}

\subsection{Glossario dei termini}

\begin{center}
    
    \begin{tabularx}{0.99\textwidth} {
        | >{\raggedright\arraybackslash}>{\hsize=.4\hsize}X |
          >{\raggedright\arraybackslash}                  X |
          >{\raggedright\arraybackslash}>{\hsize=.5\hsize}X |
    }
        \hline
        \textbf{Termine} & \textbf{Descrizione} & \textbf{Collegamenti} \\
        \hline\hline

        %Termine
        Utente &
        %Descrizione
        Utente registrato al sito &
        %Collegamenti
        Carrello, CartaDiCredito, Residenza \\ 
        \hline

        %Termine
        Prime &
        %Descrizione
        Utente dotato di un abbonamento attivo che usufruisce delle agevolazioni di acquisto e spedizione &
        %Collegamenti
        Entità figlia di Utente \\ 
        \hline

        %Termine
        Carrello &
        %Descrizione
        Zona di memorizzazione dei prodotti selezionati che non sono ancora stati acquistati  &
        %Collegamenti
        Prodotto, Ordine, Utente\\
        \hline

        %Termine
        Prodotto &
        %Descrizione
        Un bene tangibile, venduto nel sito e acquistabile da qualunque utente &
        %Collegamenti
        Fornitore, Carrello, Reso\\
        \hline

        %Termine
        Costo spedizione &
        %Descrizione
        Il costo della spedizione (nel caso di validità "Prime" questo non viene calcolato nell'importo totale) &
        %Collegamenti
        Attributo di Prodotto\\
        \hline

        %Termine
        Importo &
        %Descrizione
        Costo totale dei prodotti salvati nel carrello. Ogni prodotto comprende anche i costi di spedizione &
        %Collegamenti
        Attributo di Carrello \\ 
        \hline

        %Termine
        Fornitore &
        %Descrizione
        L'ente che produce e mette in vendita i propri prodotti &
        %Collegamenti
        Prodotto, Stabilimento \\ 
        \hline  

        %Termine
        PIVA &
        %Descrizione
        La partita IVA è una sequenza di cifre che identifica univocamente un soggetto che esercita un'attività &
        %Collegamenti
        Attributo di Fornitore \\ 
        \hline

        %Termine
        Stabilimento &
        %Descrizione
        Una sede di produzione di un fornitore &
        %Collegamenti
        Fornitore, Reso \\ 
        \hline
        
        %Termine
        Spedizione &
        %Descrizione
        Tempo che trascorre tra la presa in carico fino al punto di consegna di uno o più ordini &
        %Collegamenti
        Ordine \\ 
        \hline

        %Termine
        Codice spedizione &
        %Descrizione
        Codice univoco dal quale è possibile ottenere le date di spedizione del proprio ordine &
        %Collegamenti
        Attributo di Spedizione \\ 
        \hline

        %Termine
        PuntoDiConsegna &
        %Descrizione
        Indirizzo di spedizione &
        %Collegamenti
        Ordine \\ 
        \hline

        %Termine
        PuntoDiRitiro &
        %Descrizione
        Esercente che fornisce il proprio stabilimento per la ricezione e il ritiro delle consegne a determinati orari &
        %Collegamenti
        Entità figlia di PuntoDiConsegna \\ 
        \hline

        %Termine
        Reso &
        %Descrizione
        La possibilità di ottenere il rimborso su un prodotto acquistato  restituendolo al fornitore &
        %Collegamenti
        Ordine, Prodotto, Stabilimento \\ 
        \hline

    \end{tabularx}
\end{center}

\subsection{Operazioni}


\begin{center}
    
    \begin{tabularx}{\textwidth} {
        | >{\raggedright\arraybackslash}X |
          >{\raggedright\arraybackslash}X |
          >{\raggedright\arraybackslash}X |
    }

    \hline
    \textbf{Operazione} & \textbf{Tipo} & \textbf{Frequenza} \\
    \hline\hline

    %Operazione
    Inserimento di un nuovo utente &
    %Tipo
    S &
    %Frequenza
    500 al giorno \\
    \hline

    %Operazione
    Inserimento di un nuovo prodotto &
    %Tipo
    S &
    %Frequenza
    1000 al mese \\
    \hline

    %Operazione
    Inserimento di un nuovo ordine &
    %Tipo
    S &
    %Frequenza
    5000 al giorno \\
    \hline

    %Operazione
    Ricerca di un prodotto &
    %Tipo
    L &
    %Frequenza
    5000 all'ora \\
    \hline

    %Operazione
    Ricerca dei dati riguardanti un fornitore &
    %Tipo
    L &
    %Frequenza
    200 al giorno \\
    \hline

    %Operazione
    Visualizzazione dei prodotti nel proprio carrello &
    %Tipo
    L &
    %Frequenza
    25000 al giorno \\
    \hline

    %Operazione
    Aggiornarmento della quantità disponibile di un prodotto &
    %Tipo
    S &
    %Frequenza
    5000 al giorno \\
    \hline

    %Operazione
    Richiesta di reso di un prodotto  &
    %Tipo
    S &
    %Frequenza
    2000 al mese \\
    \hline

    %Operazione
    Visualizzazione della data di arrivo del proprio ordine &
    %Tipo
    L &
    %Frequenza
    500 al giorno \\
    \hline

    %Operazione
    Ricerca della fascia oraria di apertura di un punto di ritiro &
    %Tipo
    L &
    %Frequenza
    500 al giorno \\
    \hline
    
    \end{tabularx}
\end{center}

\section{Progettazione Concettuale}

\subsection{Lista entità}

\textbf{Se non specificato l'attributo è NOT NULL}
\begin{itemize}
    \itemsep0em 
    \item Utente
    \begin{itemize}
        \itemsep0em 
        \item \underline{Email}: varchar(100) PRIMARY KEY
        \item Nome: varchar(50)
        \item Cognome: varchar(50)
        \item NumeroTelefono: varchar(15)
        \item Password: varchar(20)
        \begin{description}
            \itemsep0em 
            \item L'entità utente si specializza in una sottocategoria con una \textbf{generalizzazione parziale}:
        \end{description}
        \item[•] Utente Prime
        \begin{itemize}
            \itemsep0em 
            \item[–] DataIscrizione: timestamp
            \item[–] DataScadenza: timestamp, (\textgreater{} DataIscrizione)
            \item[–] Abbonamento: Enumerated, ("MENSILE", "ANNUALE")
        \end{itemize}
    \end{itemize}
    \item Carrello
    \begin{itemize}
        \itemsep0em 
        \item \underline{Id}: integer PRIMARY KEY
        \item \underline{Utente}: varchar(100) PRIMARY KEY
        \item Importo: decimal, (\textgreater{}= 0)
    \end{itemize}
    \item Prodotto
    \begin{itemize}
        \itemsep0em 
        \item \underline{Codice}: varchar(14) PRIMARY KEY
        \item Nome: varchar(100)
        \item Prezzo: decimal, (\textgreater{}= 0)
        \item QuantitàDisponibile: integer, (\textgreater{}= 0)
        \item Peso: decimal, (\textgreater{} 0)
        \item Descrizione: varchar(5000)
        \item CostoSpedizione: decimal, (\textgreater{}= 0)
        \item Prime: boolean
    \end{itemize}
    \item Fornitore
    \begin{itemize}
        \itemsep0em 
        \item \underline{PIVA}: varchar(11) PRIMARY KEY
        \item Nome: varchar(50)
        \item Email: varchar(100)
        \item NumeroTelefono: varchar(15)
    \end{itemize}
    \item Stabilimento
    \begin{itemize}
        \itemsep0em 
        \item \underline{Via}: varchar(100) PRIMARY KEY
        \item \underline{NumeroCivico}: varchar(10) PRIMARY KEY
        \item \underline{CAP}: varchar(5) PRIMARY KEY
        \item \underline{Città}: varchar(100)
        \item Stato: varchar(100)
    \end{itemize}
    \item CartaDiCredito
    \begin{itemize}
        \itemsep0em 
        \item \underline{Numero}: varchar(16) PRIMARY KEY
        \item Circuito: varchar(25)
        \item Scadenza: date
        \item CVV: varchar(3)
        \item Intestatario: varchar(50)
    \end{itemize}
    \item Ordine
    \begin{itemize}
        \itemsep0em 
        \item \underline{Carrello}: integer PRIMARY KEY
        \item \underline{Utente}: varchar(100) PRIMARY KEY
        \item DataAcquisto: timestamp
        \item PreferenzeSpedizione: varchar(500) può essere NULL
    \end{itemize}
    \item Spedizione:
    \begin{itemize}
        \itemsep0em 
        \item \underline{Codice}: varchar(13) PRIMARY KEY
        \item DataPartenza: timestamp
        \item DataArrivo: timestamp (\textgreater{} DataPartenza)
        \item DataEffettiva: timestamp può essere NULL
    \end{itemize}
    \item PuntoDiConsegna
    \begin{itemize}
        \itemsep0em 
        \item \underline{Via}: varchar(100) PRIMARY KEY
        \item \underline{NumeroCivico}: varchar(10) PRIMARY KEY
        \item \underline{CAP}: varchar(5) PRIMARY KEY
        \item \underline{Città}: varchar(100)
        \begin{description}
            \itemsep0em 
            \item L'entità Punto di consegna si specializza in due sottocategorie con una \textbf{generalizzazione totale}:
        \end{description}
        \item[•] PuntoDiRitiro
        \begin{itemize}
            \itemsep0em 
            \item[–] OraApertura: time
            \item[–] OraChiusura: time, (\textgreater{} OraApertura)
        \end{itemize}
        \item[•] Residenza
    \end{itemize}
    \item Reso
    \begin{itemize}
        \itemsep0em 
        \item \underline{Utente}: varchar(100) PRIMARY KEY
        \item \underline{Carrello}: integer PRIMARY KEY
        \item \underline{Ordine}: integer PRIMARY KEY
        \item \underline{Prodotto}: varchar(14) PRIMARY KEY
        \item Quantità: integer, (\textgreater{} 0)
        \item Motivazione: varchar(500)
    \end{itemize}
\end{itemize}

\subsection{Tabella delle relazioni}

\begin{center}
    \begin{tabularx}{\textwidth} {
        | >{\raggedright\arraybackslash}>{\hsize=.4\hsize}X |
          >{\raggedright\arraybackslash}>{\hsize=.4\hsize}X |
          >{\raggedright\arraybackslash}                  X |
          >{\raggedright\arraybackslash}>{\hsize=.4\hsize}X |
    }
        \hline
        \textbf{Relazione} & \textbf{Entità coinvolte} & \textbf{Descrizione} & \textbf{Attributi} \\
        \hline\hline

        %Relazione
        Acquisto &
        %Entità coinvolte
        Carrello (0,1)
        Ordine (1,1) &
        %Descrizione
        Un utente può decidere di acquistare i prodotti che ha all'interno del carrello (facendo quindi un ordine relativo a quel carrello), oppure no e quindi non procedere all'acquisto &
        %Attributi
        Data e ora: TIMESTAMP \\ 
        \hline

        %Relazione
        Cliente &
        %Entità coinvolte
        Ordine (0,N)
        Reso (1,1) &
        %Descrizione
        Un utente può decidere di effettuare il reso di uno o più prodotti, in tal caso l'ordine permette di risalire al cliente che ha acquistato il prodotto da restituire  &
        %Attributi
        Nessuno \\ 
        \hline
        
        %Relazione
        Attività &
        %Entità coinvolte
        Fornitore (1,N)
        Prodotto (1,1) &
        %Descrizione
        Un fornitore può mettere in vendita un certo quantitativo di prodotti che quindi saranno riconducibili a lui  &
        %Attributi
        Nessuno \\ 
        \hline
        
        %Relazione
        Consegna &
        %Entità coinvolte
        Ordine (1,1)
        Spedizione (1,N) &
        %Descrizione
        Una volta effettuato un ordine, va organizzata una spedizione affinché venga consegnato all'utente  &
        %Attributi
        Nessuno \\ 
        \hline
        
        %Relazione
        Località &
        %Entità coinvolte
        Fornitore (1,N)
        Stabilimento (1,1) &
        %Descrizione
        Un fornitore avrà a disposizione uno o più stabilimenti che metteranno a disposizione i prodotti pronti per la vendita  &
        %Attributi
        Nessuno \\ 
        \hline
        
        %Relazione
        Località &
        %Entità coinvolte
        Residenza (1,N)
        Utente (0,1) &
        %Descrizione
        Un utente può registrare al più un indirizzo per la residenza a cui potrà far arrivare le spedizioni richieste  &
        %Attributi
        Nessuno \\ 
        \hline
        
        %Relazione
        Metodo di pagamento &
        %Entità coinvolte
        CartaDiCredito (1,1)
        Utente (1,N) &
        %Descrizione
        Un utente deve registrare uno o più metodi di pagamento, per poter effettuare degli acquisti  &
        %Attributi
        Nessuno \\ 
        \hline
        
        %Relazione
        Possiede &
        %Entità coinvolte
        Carrello (1,1)
        Utente (1,1) &
        %Descrizione
        Un utente avrà a disposizione un carrello in cui mettere tutti i prodotti che intende acquistare  &
        %Attributi
        Nessuno \\ 
        \hline
        
        %Relazione
        ProdottiSalvati &
        %Entità coinvolte
        Carrello (0,N)
        Prodotto (1,1) &
        %Descrizione
        Un carrello al suo interno avrà una lista di prodotti che l'utente intende acquistare &
        %Attributi
        Quantità: INTEGER \textgreater{} 0 \\ 
        \hline
        
        %Relazione
        Rifiuto &
        %Entità coinvolte
        Prodotto (0,N)
        Reso (1,1) &
        %Descrizione
        E' possibile effettuare il reso del prodotto se, ad esempio, non rispetta la descrizione con cui è stato presentato &
        %Attributi
        Nessuno \\ 
        \hline
        
        %Relazione
        Transazione &
        %Entità coinvolte
        CartaDiCredito (0,N)
        Ordine (1,1) &
        %Descrizione
        Una carta di credito può essere utilizzata per zero o più ordini, un ordine è sempre associato ad un metodo di pagamento &
        %Attributi
        Codice: VARCHAR \\ 
        \hline
        
        %Relazione
        Trasporto &
        %Entità coinvolte
        Reso (1,1)
        Stabilimento (0,N) &
        %Descrizione
        Un prodotto che viene restituito va riportato in uno stabilimento che lo prenderà in gestione per smaltirlo &
        %Attributi
        Nessuno \\ 
        \hline
        
        %Relazione
        Trasporto &
        %Entità coinvolte
        Ordine (1,1)
        PuntoDiConsegna (0,N) &
        %Descrizione
        Una volta effettuato l'ordine, esso va consegnato all'indirizzo scelto dall'utente o, alternativamente, ad un punto di ritiro &
        %Attributi
        Nessuno \\ 
        \hline

    \end{tabularx}
\end{center}

\textbf{Vincoli non rappresentabili tramite schema E-R:}
\begin{itemize}
    \itemsep0em 
    \item Un cliente può effettuare il reso solo dei prodotti che ha precedentemente acquistato e che gli sono stati consegnati
    \item L'attributo importo dell'entità ordine è uguale alla somma dei prezzi dei prodotti presenti nel carrello più le relative spese di spedizione dei singoli prodotti
\end{itemize}

\textbf{Vincoli di derivazione:}
\begin{itemize}
    \itemsep0em 
    \item Il valore degli attributi DataIscrizione e DataScadenza dell'entità utente prime devono essere coerenti con il tipo di abbonamento dell'utente
\end{itemize}

\begin{center}
    \textbf{Schema Concettuale}
\end{center}

\begin{figure}[H]
    \includegraphics[scale=0.44]{media/SampleAmazonDB.png}
    \label{Schema E-R}
\end{figure}

\section{Progettazione Logica}

\subsection{Ristrutturazione}

\subsubsection{Ananlisi delle ridondanze}

L'attributo "\textbf{Importo}" dell'entità Carrello è ridondante in quanto si potrebbe calcolare facendo la somma dei prezzi
di tutti i prodotti e del costo delle loro spedizioni presenti nel carrello.

\begin{tabularx}{\textwidth} {
        | >{\raggedright\arraybackslash}X |
          >{\raggedright\arraybackslash}X |
          >{\raggedright\arraybackslash}X |
      }

        \hline
        \textbf{Concetto} & \textbf{Tipo} & \textbf{Volume} \\
        \hline

        %Concetto
        Prodotto  &
        %Tipo
        Entità &
        %Volume
        2000000 (2M) \\
        \hline

        %Concetto
        Carrello  &
        %Tipo
        Entità &
        %Volume
        250000 (250K) \\
        \hline

        %Concetto
        ProdottiSalvati  &
        %Tipo
        Relazione &
        %Volume
        500000 (500K) \\
        \hline
    
\end{tabularx}

\begin{itemize}
    \itemsep0em 
    \item Operazione 1: Aggiungere un nuovo prodotto al carrello (10000 al giorno)
    \item Operazione 2: Visualizzare l'importo totale del carrello (25000 al giorno)
\end{itemize}
\textbf{PRESENZA RIDONDANZA}\\
Operazione 1:

\newcommand{\noline}[1]{\multicolumn{1}{c}{#1}}
\newcommand{\myline}{\cline{1-4}}
\begin{center}
    \begin{tabularx}{\textwidth} {
        | >{\raggedright\arraybackslash}X |
        >{\raggedright\arraybackslash}X |
        >{\raggedright\arraybackslash}X |
        >{\raggedright\arraybackslash}X |
        c                               |
    }

        \myline
        \textbf{Concetto} & \textbf{Costrutto} & \textbf{Accessi} & \textbf{Tipo} \\
        \myline

        %Concetto
        ProdottiSalvati &
        %Costrutto
        Relazione &
        %Accessi
        1 &
        %Tipo
        S &
        %Valore
        \noline{x 10000} \\
        \myline

        %Concetto
        Prodotto &
        %Costrutto
        Entità &
        %Accessi
        1 &
        %Tipo
        L &
        %Valore
        \noline{x 10000} \\
        \myline

        %Concetto
        Carrello &
        %Costrutto
        Entità &
        %Accessi
        1 &
        %Tipo
        L &
        %Valore
        \noline{x 10000} \\
        \myline

        %Concetto
        Carrello &
        %Costrutto
        Entità &
        %Accessi
        1 &
        %Tipo
        S &
        %Valore
        \noline{x 10000} \\
        \myline
    \end{tabularx}
\end{center}
Operazione 2:
\begin{center}
    \begin{tabularx}{\textwidth} {
        | >{\raggedright\arraybackslash}X |
        >{\raggedright\arraybackslash}X |
        >{\raggedright\arraybackslash}X |
        >{\raggedright\arraybackslash}X |
        c                               |
    }

        \myline
        \textbf{Concetto} & \textbf{Costrutto} & \textbf{Accessi} & \textbf{Tipo} \\
        \myline

        %Concetto
        Carrello &
        %Costrutto
        Entità &
        %Accessi
        1 &
        %Tipo
        L &
        %Valore
        \noline{x 25000} \\
        \myline
    \end{tabularx}
\end{center}
Perciò tenendo conto del fatto che le operazioni di scrittura valgono il doppio rispetto a quelle di lettura.\\
COSTO TOTALE: 10000*2 + 10000 + 10000 + 10000*2 + 25000 = 85000 (85K)\\\\
\textbf{ASSENZA RIDONDANZA}

\begin{center}
    \begin{tabularx}{\textwidth} {
        | >{\raggedright\arraybackslash}X |
        >{\raggedright\arraybackslash}X |
        >{\raggedright\arraybackslash}X |
        >{\raggedright\arraybackslash}X |
        c                               |
    }

        \myline
        \textbf{Concetto} & \textbf{Costrutto} & \textbf{Accessi} & \textbf{Tipo} \\
        \myline

        %Concetto
        ProdottiSalvati &
        %Costrutto
        Relazione &
        %Accessi
        1 &
        %Tipo
        S &
        %Valore
        \noline{x 10000} \\
        \myline
    \end{tabularx}
\end{center}
Operazione 2:\\
Sono presenti in media 500000 / 250000 = 2 prodotti a carrello
\begin{center}
    \begin{tabularx}{\textwidth} {
        | >{\raggedright\arraybackslash}X |
        >{\raggedright\arraybackslash}X |
        >{\raggedright\arraybackslash}X |
        >{\raggedright\arraybackslash}X |
        c                               |
    }

        \myline
        \textbf{Concetto} & \textbf{Costrutto} & \textbf{Accessi} & \textbf{Tipo} \\
        \myline

        %Concetto
        Carrello &
        %Costrutto
        Entità &
        %Accessi
        1 &
        %Tipo
        L &
        %Valore
        \noline{x 25000} \\
        \myline

        %Concetto
        ProdottiSalvati &
        %Costrutto
        Relazione &
        %Accessi
        2 &
        %Tipo
        L &
        %Valore
        \noline{x 25000} \\
        \myline

        %Concetto
        Prodotto &
        %Costrutto
        Entità &
        %Accessi
        2 &
        %Tipo
        L &
        %Valore
        \noline{x 25000} \\
        \myline
    \end{tabularx}
\end{center}
COSTO TOTALE: 10000*2 + 10000 + 25000*2 + 25000*2 = 130000 (130K)\\\\
Dall'analisi eseguita risulta quindi che la presenza dell'attributo importo può risparmiare quotidianamente
il costo computazionale di (130K - 85K) = 45K operazioni, perciò verrà mantenuto.

\subsubsection{Eliminazione delle generalizzazioni}

\begin{center}
    \begin{tabularx}{\textwidth} {
        | >{\raggedright\arraybackslash}>{\hsize=.4\hsize}X |
          >{\raggedright\arraybackslash}>{\hsize=.6\hsize}X |
        }
    
        \hline
        \textbf{Generalizzazione} & \textbf{Risoluzione} \\
        \hline\hline

        %Generalizzazione
        Utente \textless{}--- Prime &
        %Risoluzione
        L'entità Prime viene accorpata in Utente, per distinguere un utente standard da uno prime non viene aggiunto
        alcun attributo. Gli attributi Abbonamento, DataIscrizione e DataScadenza diventano perciò opzionali e 
        assumeranno valore NULL per tutti gli utenti che non si sono mai abbonati. Gli utenti prime con un abbonamento
        scaduto verranno considerati come degli utenti standard  \\
        \hline

        %Generalizzazione
        PuntoDiConsegna \textless{}--- Residenza, PuntoDiRitiro &
        %Risoluzione
        Le entità Residenza e PuntoDiRitiro ereditano l'attributo composto Indirizzo da PuntoDiConsegna.
        Perciò si rimuove l'entità padre e vengono create due nuove relazioni di Trasporto tra Ordine (0,1) 
        - Residenza (0,N) e Ordine (0,1) - PuntoDiRitiro (0,N)  \\
        \hline

    \end{tabularx}
\end{center}

\subsubsection{Scelta degli identificatori primari}

Per l'entità Carrello è stato deciso di utilizzare come chiave primaria un attributo composto formato da:
\begin{itemize}
    \itemsep0em 
    \item L'attributo Utente, che è anche chiave esterna della relazione Carrello - Utente.
    \item L'attributo Id.
\end{itemize}
Perciò attraverso l'identificatore primario ogni volta che un utente acquista il proprio carrello sarà
possibile risalire ai prodotti di quell'ordine e ad ogni acquisto effettuato verrà aggiornato il valore di Id per 
creare un nuovo carrello vuoto.\\\\
Durante la fase di progettazione logica si è notato che le entità Utente, Reso e Ordine per poter far riferimento 
ad uno specifico indirizzo dovevano aggiungere quattro nuovi attributi (NumeroCivico, Via, Citta, CAP) aumentando
la ridondanza e rendendo più difficile l'aggiornamento delle tabelle.\\\\
Si è deciso perciò di creare una nuova entità \textbf{Indirizzo}:
\begin{itemize}
    \itemsep0em 
    \item[-] \underline{Id}: Integer PRIMARY KEY
    \item[-] Via: varchar(100)
    \item[-] NumeroCivico: varchar(10)
    \item[-] Citta: varchar(100)
    \item[-] CAP: varchar(5)
\end{itemize}
Dotata delle seguenti relazioni

\begin{center}
    \begin{tabularx}{\textwidth} {
        | >{\raggedright\arraybackslash}>{\hsize=.4\hsize}X |
          >{\raggedright\arraybackslash}>{\hsize=.5\hsize}X |
          >{\raggedright\arraybackslash}                  X |
          >{\raggedright\arraybackslash}>{\hsize=.4\hsize}X |
        }

        \hline
        \textbf{Relazione} & \textbf{Entità coinvolte} & \textbf{Descrizione} & \textbf{Attributi} \\
        \hline\hline

        %Relazione
        Località &
        %Entità Coinvolte
        Indirizzo(1,1)
        Residenza(1,1) &
        %Descrizione
        L'indirizzo di consegna che la identifica &
        %Attributi
        Nessuno \\
        \hline

        %Relazione
        Località &
        %Entità Coinvolte
        Indirizzo(1,1)
        PuntoDiRitiro(1,1) &
        %Descrizione
        L'indirizzo di consegna che la identifica &
        %Attributi
        Nessuno \\
        \hline

        %Relazione
        Località &
        %Entità Coinvolte
        Indirizzo(1,1)
        Stabilimento(1,1) &
        %Descrizione
        L'indirizzo di consegna che la identifica &
        %Attributi
        Nessuno \\
        \hline

    \end{tabularx}
\end{center}
Le entità Stabilimento, PuntoDiRitiro e Residenza avranno come chiave primaria l'Id al loro indirizzo.

\begin{center}
    \textbf{Schema E-R ristrutturato}
\end{center}

\begin{figure}[H]
    \includegraphics[scale=0.48]{media/ER risolto.png}
    \label{Schema E-R risolto}
\end{figure}

\subsection{Crezione delle tabelle} 

(A→B indica che B è chiave esterna di A)\\
\textbf{Indirizzo}(\underline{Id}, Via, NumeroCivico, Città, CAP)\\
\textbf{Stabilimento}(\underline{Id} → Indirizzo.Id, Stato, Fornitore → Fornitore.PIVA)\\
\textbf{Fornitore}(\underline{PIVA}, Nome, NumeroTelefono, email)\\
\textbf{Prodotto}(\underline{Codice}, Nome, Prezzo, Prime, CostoSpedizione, Descrizione, Peso, QuantitaDisponibile, Fornitore→Fornitore.PIVA)\\
\textbf{Reso}(\underline{Prodotto} → Prodotto.Codice, \underline{Ordine} → Ordine.Carrello, \underline{Utente} → Ordine.Utente, Motivazione, Indirizzo → Stabilimento.Id)\\
\textbf{ProdottiSalvati}(\underline{Prodotto} → Prodotto.Codice, \underline{Carrello} → Carrello.Id, \underline{Utente} → Carrello.Utente, Quantita')\\
\textbf{Spedizione}(\underline{Codice}, DataPartenza, DataArrivo, DataEffettiva)\\
\textbf{Ordine}(\underline{Carrello} → Carrello.Id, \underline{Utente} → Carrello.Utente, Data, PreferenzeSpedizione, CartaDiCredito → CartaDiCredito.Numero, CodiceTransazione, CodiceSpedizione → Spedizione.codice, Residenza → Residenza.id, PuntoDiRitiro → PuntoDiRitiro.id)\\
\textbf{Carrello}(\underline{Id}, \underline{Utente} → Utente.Email, Importo)\\
\textbf{Utente}(\underline{Email}, Password, Nome, Cognome, NumeroTelefono, Abbonamento, DataIscrizione, DataScadenza, Residenza → Residenza)\\
\textbf{CartaDiCredito}(\underline{Numero}, Circuito, Scadenza, CVV, Intestatario, Utente → Utente.Email)\\
\textbf{Residenza}(\underline{Id} → Indirizzo.Id)\\
\textbf{PuntoDiRitiro}(\underline{Id} → Indirizzo.Id, OrarioApertura, OrarioChiusura)

\section{Query e indici}

\subsection{Query}

1. Selezionare l'email ed il numero totale di resi di ogni utente.

\begin{lstlisting}[language=SQL]

    SELECT Utente.Email, COUNT(*) as NumeroResi
    FROM Reso, Utente
    WHERE Reso.Utente = Utente.Email
    GROUP BY Utente.Email
    ORDER BY NumeroResi DESC
\end{lstlisting}

\begin{center}
    \begin{figure}[H]
        \includegraphics[scale=1]{media/query1.png}
        \label{query1}
    \end{figure}
\end{center}
2. Selezionare le informazioni dei fornitori che emettono il maggior numero di prodotti prime, i primi 5.

\begin{lstlisting}[language=SQL]

    SELECT Nome, NumeroTelefono, Email, ProdottiPrime
    FROM Fornitore JOIN
    (
        SELECT Fornitore as PIVA, COUNT(*) as ProdottiPrime
        FROM Prodotto
        WHERE Prime = TRUE
        GROUP BY PIVA
        ORDER BY ProdottiPrime DESC
        LIMIT(5)
    ) as FornitorePrime
    ON Fornitore.PIVA = FornitorePrime.PIVA
\end{lstlisting}

\begin{center}
    \begin{figure}[H]
        \includegraphics[scale=1]{media/query2.png}
        \label{query2}
    \end{figure}
\end{center}
3. Selezionare gli utenti che hanno acquistato almeno un prodotto realizzato da un fornitore che possiede almeno
uno stabilimento all'estero e la città della loro residenza.

\begin{lstlisting}[language=SQL]

    DROP VIEW IF EXISTS FornitoreEstero;
    CREATE VIEW FornitoreEstero as
    SELECT PIVA
    FROM Fornitore, Stabilimento
    WHERE Stabilimento.Fornitore = Fornitore.PIVA
    AND Stato <> 'IT';

    SELECT Nome, Cognome, Citta
    FROM Utente, Indirizzo,
    (
        SELECT DISTINCT ProdottiAcquistati.Utente
        FROM Prodotto JOIN
        (
            SELECT ProdottiSalvati.Prodotto, ProdottiSalvati.Utente
            FROM Ordine, Carrello, ProdottiSalvati
            WHERE Ordine.Carrello = Carrello.id
            AND Ordine.Utente = Carrello.Utente
            AND Carrello.id = ProdottiSalvati.Carrello
            AND Carrello.Utente = ProdottiSalvati.Utente
        ) as ProdottiAcquistati
        ON ProdottiAcquistati.Prodotto = Prodotto.Codice
        WHERE Prodotto.Fornitore IN (SELECT * FROM FornitoreEstero)
    ) as Utenti
    WHERE Utente.Email = Utenti.Utente
    AND Utente.Residenza = Indirizzo.id;
\end{lstlisting}

\begin{center}
    \begin{figure}[H]
        \includegraphics[scale=1]{media/query3.png}
        \label{query3}
    \end{figure}
\end{center}
4. Selezionare i prodotti, la quantità, l'ordine e il codice di spedizione delle ultime 5
spedizioni effettuate all'indirizzo "Via Trieste, 63, 35121, Padova".

\begin{lstlisting}[language=SQL]

    SELECT Nome, Quantita, ProdottiAcquistati.Ordine, ProdottiAcquistati.Utente,
           ProdottiAcquistati.CodiceSpedizione
    FROM Prodotto JOIN
    (
        SELECT Prodotto as Codice, Quantita, InfoAcquisto.Carrello as Ordine,
               InfoAcquisto.Utente, InfoAcquisto.Codice as CodiceSpedizione
        FROM ProdottiSalvati JOIN 
        (
            SELECT Carrello, Utente, Codice
            FROM Ordine JOIN Spedizione
            ON Ordine.CodiceSpedizione = Spedizione.Codice
            WHERE Ordine.PuntoDiRitiro = 
            (
                SELECT Id 
                FROM Indirizzo
                WHERE Via = 'Via Trieste'
                AND NumeroCivico = '63'
                AND CAP = '35121'
                AND Citta = 'Padova'
            )
            ORDER BY DataEffettiva
            LIMIT(5)
        ) as InfoAcquisto
        ON InfoAcquisto.Utente = ProdottiSalvati.Utente
        AND InfoAcquisto.Carrello = ProdottiSalvati.Carrello
    ) as ProdottiAcquistati
    ON Prodotto.Codice = ProdottiAcquistati.Codice
\end{lstlisting}

\begin{center}
    \begin{figure}[H]
        \includegraphics[scale=1]{media/query4.png}
        \label{query4}
    \end{figure}
\end{center}
5. Selezionare l'email, il tipo di abbonamento e la carta di credito più usata
degli utenti che hanno una spesa totale maggiore di 500 euro.

\begin{lstlisting}[language=SQL]

    DROP VIEW IF EXISTS OrdiniPerCircuto;
    CREATE VIEW OrdiniPerCircuto as
    SELECT Circuito, Ordine.Utente, COUNT(*) as OrdiniEffettuati
    FROM Ordine, CartaDiCredito
    WHERE Ordine.CartaDiCredito = CartaDiCredito.Numero
    GROUP BY Circuito, Ordine.Utente;
    
    SELECT UtenteDatoImportoTotale.Email, UtenteDatoImportoTotale.Abbonamento,
    OrdiniPerCircuto.Circuito, UtenteDatoImportoTotale.ImportoTotale
    FROM OrdiniPerCircuto,
    (
        SELECT Utente.Email as Email, Abbonamento, SpesaUtente.ImportoTotale
        FROM Utente JOIN
        (
            SELECT Carrello.Utente as Email, SUM(Importo) as ImportoTotale
            FROM Ordine, Carrello
            WHERE Ordine.Utente = Carrello.Utente
            AND Ordine.Carrello = Carrello.Id
            GROUP BY Carrello.Utente
            HAVING SUM(Importo) >= 500
        ) as SpesaUtente
        ON Utente.Email = SpesaUtente.Email
    ) as UtenteDatoImportoTotale
    WHERE UtenteDatoImportoTotale.Email = OrdiniPerCircuto.Utente
    AND OrdiniPerCircuto.OrdiniEffettuati = 
    (
        SELECT MAX(OrdiniEffettuati)
        FROM OrdiniPerCircuto
        WHERE OrdiniPerCircuto.Utente = UtenteDatoImportoTotale.Email
    )
\end{lstlisting}

\begin{center}
    \begin{figure}[H]
        \includegraphics[scale=1]{media/query5.png}
        \label{query5}
    \end{figure}
\end{center}

\subsection{Indici}

La ricerca di un prodotto è un operazione che viene eseguita molto spesso in lettura dato
che la loro ricerca viene eseguita dagli utenti e anche vengono inseriti automaticamente tra i prodotti consigliati
e nella home del sito. Quindi per diminuire il più possibile la latenza nella ricerca e nel caricamento delle pagine 
si è deciso di indicizzare l'attributo Nome della tabella Prodotto nell'indice NomiProdotti.

\begin{lstlisting}[language=SQL]
    CREATE INDEX NomiProdotti ON Prodotto(Nome);
\end{lstlisting}

\section{Codice C++}

\subsection{Descrizione dell'utilizzo del codice}

Il codice C++ per l’esecuzione delle query consiste in un unico file .cpp compilabile con il comando
\begin{lstlisting}
    g++ main.cpp -L dependencies\lib -lpq -o main
\end{lstlisting}
A questo punto il comando necessario per l'esecuzione del programma è \textbf{./main}. \\
Prima che il programma esegui le query si cerca di stabilire la connessione con il database attraverso le credenziali e la password di un utente registrato al sistema
di gestione basi di dati e solo nel caso la connessione vada a buon fine si procederà con la scrittura e l'esecuzione delle query riportate nel punto 5
per l'interrogazione al database, i risultati verranno stampati a video in formato tabulare. \\
La query numero 4 richiederà l’inserimento di alcuni parametri da parte dell’utente per la ricerca:
\begin{itemize}
    \itemsep0em 
    \item Via
    \item Numero civico
    \item CAP
    \item Città
\end{itemize}
Si fa notare che qualora i parametri non vengano inseriti come riportato dal programma nel momento dell'esecuzione, la query potrebbe non restituire i risultati attesi.

\subsection{Documentazione codice}
Funzioni e pezzi di codice interessanti utilizzati dal programma:\\
\begin{lstlisting}[language=C++]
    void checkResults(PGresult* res, const PGconn* conn)
\end{lstlisting}
Controlla che il risultato della query contenga la flag di validità altrimenti stamperà a video il messaggio di errore.\\

\begin{lstlisting}[language=C++]
	
    char conninfo[250];
	
    sprintf(conninfo, "user=%s password=%s dbname=%s hostaddr=%s port=%d",
    		    PG_USER, PG_PASS, PG_DB, PG_HOST, PG_PORT);
	
    PGconn *conn = PQconnectdb(conninfo);
	
    if(PQstatus(conn) != CONNECTION_OK) {
        cout<<"Errore di connessione"<<std::endl<<PQerrorMessage(conn);
        PQfinish(conn);
    }
\end{lstlisting}
Cerca di stabilire la connessione al database inviando verso un determinato server (host:porta) le credenziali di accesso al database specificato.
Se la connessione non va a buon fine verrà mostrato un messaggio di errore altrimenti la computazione continuerà. \\

\begin{lstlisting}[language=C++]
    res = PQexec(conn, query_1.c_str());
\end{lstlisting}
Prende come paramentri di input la connessione al database e la query e riceve il risultato associato. \\
 
\begin{lstlisting}[language=C++]
    template<typename T> void printElement(T t, const int& width)
\end{lstlisting}
Template di funzione che permette di tabulizzare i risultati di una query utlizzando la libreria 'iomanip'. \\

\begin{lstlisting}[language=C++]

    const char* params[] = {via.c_str(), ncv.c_str(), cap.c_str(), citta.c_str()};

    res = PQexecParams(conn, query_4.c_str(), 4, NULL, params, NULL, NULL, 0);
\end{lstlisting}
Questa parte del programma si occupa dell'inserimento di dati da parte dell'utente via tastiera.
La funzione riceve in input la connessione al database, la query e i dati necessari per la processazione dei parametri
ovvero il numero totale e il loro valore.
\end{document}

\end{document}